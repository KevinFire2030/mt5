# vTrader v1.0 설계 문서

## 1. 개요

- 프로그램 명 : vTrader
- 프로그램 버전 : 1.0
- 프로그램 목적 : 터틀 트레이딩 기반의 자동 매매
- 프로그램 설명 : 터틀 트레이딩 기법을 기반으로 한 자동 매매 프로그램으로, 트레이딩 전략을 설정하고 자동으로 매매를 수행합니다.
- 거래 플랫폼: MetaTrader 5
- 브로커: FxPro
- 통신 방법: MetaTrader 5 내장 메시지
- 언어: MQL5

## 2. 프로그램 구조

- 프로그램은 크게 5 가지 기능으로 구성됩니다
- 자금 관리
- 리스크 관리
- 피라미딩
- 진입/청산 전략
- 매매(포지션) 관리
   
## 3. 자금 관리

- 터틀의 자금 관리 기법을 기반으로 합니다.
- 모든 포지션의 크기는 동일하게 터틀의 1유닛으로 합니다.
- 터틀의 1유닛 계산 방법은 다음과 같습니다.
    - atr 값을 계산하여 1달러당 변동폭을 계산합니다.
    - 계산된 변동폭을 기준으로 전체 자산의 1%를 계산하여 1유닛을 계산합니다.
    - 1유닛 = 전체 자산 * 1% / 달러당 변동폭
- ATR 기간: 20일
- 최소 거래 단위: 0.01랏 (종목별 최소 거래 단위는 종목별 최소 거래 단위로 설정)


## 4. 리스크 관리

- 터틀의 리스크 관리 기법을 기반으로 합니다.
- 모든 포지션의 리스크는 동일하게 2N로 설정합니다.
- 2N = 2 * ATR
- 포지션 진입시 SL을 진입가 ±2N로 설정합니다.
- 피라미딩시 기존 포지션의 SL은 현재 포지션의 SL로 변경합니다.

## 5. 피라미딩

- 피라미딩은 터틀의 피라미딩 기법을 기반으로 합니다.
- 기존 포지션의 진입가에서 ±1/2N 만큼의 가격 변동시 동일한 방향으로 포지션을 추가합니다.
- 포지션 추가시 포지션 크기는 동일하게 1유닛으로 추가합니다.
- 포지션 추가시 최대 포지션 수는 심볼당 4개로 제한합니다.
- 포지션 추가시 기존 포지션의 SL은 신규로 진입한 포지션의 SL로 재설정합니다.

## 6. 진입/청산 전략

- 진입/청산 전략은 EMA 정배열/역배열 전략을 기반으로 합니다.
    - 진입: 
        - 롱포지션: EMA5 > EMA20 > EMA40
        - 숏포지션: EMA5 < EMA20 < EMA40
    - 청산:
        - 롱포지션: EMA 정배열 이탈시
        - 숏포지션: EMA 역배열 이탈시
  
## 7. 매매(포지션) 관리
- Timeframe: 사용자 입력 (EA 실행시 사용자 선택, 기본 1분봉)
- 리스크: 사용자 입력 (EA 실행시 사용자 선택, 기본 0.01)
- 최대 포지션 수: 사용자 입력 (EA 실행시 사용자 선택, 기본 15)
- 심볼별 최대 피라미딩 수: 사용자 입력 (EA 실행시 사용자 선택, 기본 4)
- 거래 심볼: MarketWatch 심볼 리스트에 있는 심볼 (프로그램 실행시 초기화)

## 8. 프로그램 흐름도
1. EA 초기화
    - 사용자 입력: Timeframe, 리스크, 최대 포지션 수, 심볼별 최대 피라미딩 수
    - 터틀의 자금 관리 기법을 기반으로 1유닛 계산
    - 리스크 관리 설정: 모든 포지션의 리스크는 동일하게 2N로 설정
    - 피라미딩 설정: 기존 포지션의 진입가에서 ±1/2N 만큼의 가격 변동시 동일한 방향으로 포지션 추가
    - 매매(포지션) 관리 설정: Timeframe, 리스크, 최대 포지션 수, 심볼별 최대 피라미딩 수

    // 매 시작 시점 확인
    if(currentBarTime != lastBarTime)
    {
        // 1분봉이 완성 시점 확인
        if(currentBarTime % 60 == 0)
        {
            // 여기에 매매 로직을 추가할 수 있습니다.
        }
    }



2. 차트 분석 및 포지션 진입
    - EMA 정배열/역배열 전략을 기반으로 진입/청산 결정
    - 롱포지션: EMA5 > EMA20 > EMA40
    - 숏포지션: EMA5 < EMA20 < EMA40
    - 포지션 진입시 SL을 진입가 ±2N로 설정

3. 피라미딩 실행
    - 기존 포지션의 진입가에서 ±1/2N 만큼의 가격 변동시 동일한 방향으로 포지션 추가
    - 포지션 추가시 포지션 크기는 동일하게 1유닛으로 추가
    - 포지션 추가시 최대 포지션 수는 심볼당 4개로 제한
    - 포지션 추가시 기존 포지션의 SL은 신규로 진입한 포지션의 SL로 재설정

4. 포지션 관리 및 청산
    - EMA 정배열 이탈시 롱포지션 청산
    - EMA 역배열 이탈시 숏포지션 청산
    - 모든 포지션의 리스크는 동일하게 2N로 관리
    - 피라미딩시 기존 포지션의 SL은 현재 포지션의 SL로 변경

5. EA 종료
    - EA가 종료되면 모든 포지션을 청산
    - EA 종료 로그 출력



