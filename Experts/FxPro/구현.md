# vTrader v1.0 구현 계획

## 1. 클래스 구조

### CvTrader (메인 클래스) 
```cpp
class CvTrader
{
private:
// 설정 관련 멤버 변수
ENUM_TIMEFRAMES m_timeframe;
double m_risk;
int m_maxPositions;
int m_maxPyramiding;
// 자금 관리 관련
CTurtleMoneyManager m_moneyManager;
// 리스크 관리 관련
CRiskManager m_riskManager;
// 포지션 관리 관련
CPositionManager m_positionManager;
// 시그널 관련
CSignalManager m_signalManager;
public:
// 생성자/소멸자
void CvTrader();
void ~CvTrader();
// 초기화/해제
bool Init();
void Deinit();
// 틱 처리
void OnTick();
};
```
### CTurtleMoneyManager (자금 관리 클래스)
- ATR 기반 1유닛 계산
- 최소 거래 단위 관리
- 포지션 크기 계산

### CRiskManager (리스크 관리 클래스)
- 2N 기반 SL 계산
- 포지션별 리스크 관리
- 전체 리스크 관리

### CPositionManager (포지션 관리 클래스)
- 포지션 오픈/클로즈
- 피라미딩 관리
- SL 관리

### CSignalManager (시그널 관리 클래스)
- EMA 계산
- 진입/청산 시그널 생성

## 2. 구현 순서

1. 기본 프레임워크 구현
   - CvTrader 클래스 기본 구조 구현
   - 각 매니저 클래스 기본 구조 구현
   - OnTick() 이벤트 처리 구조 구현

2. 지표 계산 구현
   - EMA 계산 구현 (5, 20, 40)
   - ATR 계산 구현 (20일)

3. 자금 관리 구현
   - ATR 기반 1유닛 계산 구현
   - 최소 거래 단위 처리 구현

4. 리스크 관리 구현
   - 2N 기반 SL 계산 구현
   - 포지션별 리스크 관리 구현

5. 포지션 관리 구현
   - 포지션 오픈/클로즈 구현
   - 피라미딩 로직 구현
   - SL 관리 구현

6. 시그널 관리 구현
   - EMA 정배열/역배열 판단 구현
   - 진입/청산 시그널 생성 구현

7. 테스트 및 최적화
   - 단위 테스트 구현
   - 백테스팅 수행
   - 성능 최적화

## 3. 주요 함수 명세

### CvTrader

```cpp
// 초기화
bool Init()
{
// 사용자 입력값 검증
// 각 매니저 클래스 초기화
// 초기 데이터 로드
}
// 틱 처리
void OnTick()
{
// 새로운 봉 확인
// 지표 업데이트
// 시그널 체크
// 포지션 관리
}
```

### CTurtleMoneyManager

```cpp
// 1유닛 계산
double CalculateUnitSize(string symbol)
{
// ATR 기반 변동폭 계산
// 계좌 자금 고려
// 최소 거래 단위 적용
}
```
### CRiskManager
```cpp
// SL 계산
double CalculateStopLoss(string symbol, ENUM_POSITION_TYPE type, double entryPrice)
{
// 2N 기반 SL 계산
// 심볼 특성 고려
}

```

### CPositionManager
```cpp
// 피라미딩 체크
bool CheckPyramiding(string symbol, ENUM_POSITION_TYPE type)
{
// 기존 포지션 확인
// 피라미딩 조건 확인
// 최대 포지션 수 확인
}
```

### CSignalManager
```cpp
// 진입 시그널 체크
ENUM_POSITION_TYPE CheckEntrySignal(string symbol)
{
// EMA 정배열/역배열 확인
// 진입 조건 확인
}
```

## 4. 테스트 계획

1. 단위 테스트
   - 각 클래스별 주요 함수 테스트
   - 경계값 테스트
   - 예외 처리 테스트

2. 통합 테스트
   - 클래스간 상호작용 테스트
   - 전체 시스템 흐름 테스트

3. 백테스팅
   - 다양한 시장 상황에서의 테스트
   - 다양한 타임프레임에서의 테스트
   - 다양한 심볼에서의 테스트

4. 실시간 테스트
   - 데모 계좌에서의 테스트
   - 소액 실계좌에서의 테스트

## 5. 로깅 계획

- 거래 로그
  - 진입/청산 정보
  - 손익 정보
  - SL 변경 정보

- 시스템 로그
  - 초기화/종료 정보
  - 에러/경고 정보
  - 성능 정보

## 6. 예외 처리 계획

- 주문 실패 처리
- 통신 오류 처리
- 데이터 누락 처리
- 시스템 리소스 부족 처리

## 2023-10-31 구현 내용

### 1. 기본 구조 구현
- vTrader.mqh: 메인 트레이딩 클래스 구현
- vTrader.mq5: EA 메인 파일 구현

### 2. 데이터 관리
#### 가격 데이터
- 시가(m_opens), 고가(m_highs), 저가(m_lows), 종가(m_closes) 배열
- 틱볼륨(m_tickVolumes) 배열
- 최근 100개 봉 데이터 유지

#### 지표 데이터
- EMA5, EMA20, EMA40 (이동평균선)
- ATR (Average True Range)
- 각 지표별 핸들과 버퍼 관리

### 3. 주요 기능
- IsNewBar(): 새로운 봉 생성 확인
- UpdatePriceArrays(): 가격 데이터 업데이트
- UpdateIndicators(): 지표 데이터 업데이트
- PrintData(): 데이터 모니터링 출력

### 4. 데이터 출력 형식

=== 데이터 확인 (N-2) ===
시간: 2024.10.31 07:54, 시가: 20286.65, 고가: 20288.15, 저가: 20285.90, 종가: 20288.15, 틱볼륨: 159
EMA5: 20287.39, EMA20: 20287.25, EMA40: 20288.11, ATR: 2.93
==================

### 5. 봉 데이터 특성
- N-0: 현재 진행 중인 미완성 봉
  - 시가, 고가, 저가, 종가가 동일
  - 틱볼륨이 매우 낮음
  - 가격 변동이 아직 없음
- N-1: 직전에 완성된 봉
- N-2: 2번째 이전 완성된 봉

### 6. 트레이딩 고려사항
- 거래 판단은 완성된 봉(N-1)을 기준으로 해야 함
- N-0 봉은 진행중이라 변동성이 크므로 참고용으로만 사용
- 각 지표들의 교차나 패턴은 완성된 봉을 기준으로 판단

### 다음 단계
- 매니저 클래스 구현 (시그널, 포지션, 리스크 관리)
- 진입/청산 로직 구현
