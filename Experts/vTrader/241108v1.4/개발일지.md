# vTrader v1.4 개발일지 (2024-11-08)

## 오늘의 작업 내용

### 1. Git 저장소 정리
- `.gitignore` 파일 설정으로 불필요한 파일 추적 제외
  - 컴파일된 파일들 (*.ex5)
  - 로그 파일들 (*.log)
  - MetaTrader 기본 폴더들
- Git 캐시 초기화 및 저장소 정리
  - `git rm -r --cached .` 명령으로 캐시 초기화
  - 새로운 `.gitignore` 규칙 적용

### 2. 작업 환경 설정
- 새로운 작업 폴더 생성: `Experts/vTrader/241108v1.4`
- 이전 버전(241107v1.4)에서 파일 복사
  - deal_history.mq5
  - deal_history2.mq5
  - tick_info_test.mq5
  - tick_info_test2.mq5
  - trade_time_test.mq5
  - vTrader_v1.2_trade_time.mqh
  - vTrader_v1.4.mq5
  - v1.4.md

## 앞으로의 계획
1. [ ] 코드 개선 사항 검토
2. [ ] 버그 수정
3. [ ] 새로운 기능 추가

## 참고 사항
- 로그 파일은 자동으로 .gitignore에 의해 관리됨
- 컴파일된 파일들은 로컬에서만 관리

## MqlTick 구조체 분석
MqlTick 구조체는 MetaTrader 5의 틱 데이터를 저장하는 기본 구조체입니다.

### 구조체 필드 설명

struct MqlTick
{
    datetime time;          // 틱 시간 (마지막 가격 업데이트)
    double   bid;          // 현재 매수 호가
    double   ask;          // 현재 매도 호가
    double   last;         // 마지막 거래 가격
    ulong    volume;       // 현재 틱의 거래량 (정수)
    long     time_msc;     // 틱 생성 시간 (밀리초)
    uint     flags;        // 틱 플래그
    double   volume_real;  // 현재 틱의 거래량 (실수)
};

### 주요 필드 설명
1. **가격 정보**
   - bid: 매수 호가 (구매자의 제시가)
   - ask: 매도 호가 (판매자의 제시가)
   - last: 마지막 체결 가격

2. **시간 정보**
   - time: 초 단위 시간
   - time_msc: 밀리초 단위 시간

3. **거래량 정보**
   - volume: 정수형 거래량
   - volume_real: 실수형 거래량

4. **플래그 정보**
   - TICK_FLAG_BID: Bid 가격 변경
   - TICK_FLAG_ASK: Ask 가격 변경
   - TICK_FLAG_LAST: Last 가격 변경
   - TICK_FLAG_VOLUME: Volume 변경
   - TICK_FLAG_BUY: 매수로 인한 틱
   - TICK_FLAG_SELL: 매도로 인한 틱

### 활용
- 시장 분석
- 거래 전략 개발
- 백테스팅
- 실시간 시장 모니터링

### Volume과 Volume_real의 정확한 의미 (MQL5 공식 문서)

1. **Volume (ulong)**
   - 마지막 거래 이후 누적된 틱 거래량
   - 주식/선물: 계약 수
   - 외환: 딜 수(number of deals)
   - 정수형으로만 표현 가능

2. **Volume_real (double)**
   - 마지막 거래의 실제 거래량
   - 주식/선물: 실제 계약 수 (소수점 포함 가능)
   - 외환: 로트 단위 (예: 0.1 lot = 10,000 통화 단위)
   - 실수형으로 정확한 거래량 표현 가능

### 중요한 차이점
- Volume: 틱 이후 누적된 총 거래량을 정수로 표현
- Volume_real: 해당 틱에서의 실제 거래량을 실수로 표현
- 특히 소규모 거래나 정밀한 거래량 분석이 필요한 경우 Volume_real 사용이 권장됨

### 틱 데이터 분석 (2024.11.07 01:00:03 데이터 샘플)

1. **시간 분석**
   - 1초(01:00:03) 동안 8개의 틱 발생
   - 밀리초 단위로 보면 1730941203035 ~ 1730941203435 (약 400밀리초 간격)
   - 평균적으로 50밀리초마다 틱 발생

2. **가격 변동**
   - Bid: 20823.40 ~ 20825.70 (2.3포인트 변동)
   - Ask: 20825.05 ~ 20827.35 (2.3포인트 변동)
   - Last: 20823.40 ~ 20825.40 (2포인트 변동)
   - 스프레드: 약 2.65 포인트로 유지됨

3. **거래량**
   - Volume: 모든 틱에서 20
   - Volume_real: 모든 틱에서 20.00
   - 일정한 크기(20계약)의 거래가 연속적으로 발생

4. **플래그 분석**
   - 280: LAST + VOLUME (�� 거래 체결 발생)
   - 1030: BID + ASK + VOLUME (호가 변경)
   - 플래그 패턴으로 보아 호가 변경과 체결이 번갈아 발생

### 특이사항
- 1초라는 짧은 시간에 8개의 틱이 발생할 만큼 활발한 거래
- 거래량이 일정하게 유지되는 것으로 보아 알고리즘 거래 가능성
- Bid와 Last 가격이 동일한 경우가 많음 (매도 체결 우세)

### 나스닥 선물(#USNDAQ100)의 Volume 분석

1. **거래 사양**
   - Contract Size = 1
   - Tick size = 0.01
   - Minimal volume = 0.01

2. **Volume 표시 방식**
   - Volume = 10은 0.01 계약을 의미
   - Volume = 20은 0.02 계약을 의미
   - Volume = 100은 0.1 계약을 의미
   - Volume = 1000은 1 계약을 의미
   - 즉, Volume 값을 1000으로 나누면 실제 계약 수가 됨

3. **실제 데이터 분석 결과**
   - 최소 Volume: 10 (= 0.01 계약)
   - 최대 Volume: 285 (= 0.285 계약)
   - Volume과 Volume_real이 정확히 일치
   - 실제 거래의 최소 단위는 0.01 계약(Volume=10)임을 확인

### 중요한 발견
- 나스닥 선물의 실제 최소 거래 단위는 0.01 계약
- 이는 Volume = 10으로 표시됨
- 이전 분석에서 계약 수 환산이 잘못되었음을 확인하고 수정

### EURUSD의 Volume 분석

1. **Volume 표시 방식**
   - 최소 Volume: 4,000 = 0.04 lot
   - 최대 Volume: 44,000,000 = 440 lot
   - Volume 값을 100,000으로 나누면 실제 lot 수가 됨

2. **Volume과 Volume_real의 특징**
   - Volume과 Volume_real이 정확히 일치
   - 외환의 경우 통화 단위로 표시됨
   - 1 lot = 100,000 통화 단위

### 나스닥 선물과 외환의 Volume 표시 방식 비교

1. **나스닥 선물 (#USNDAQ100)**
   - Volume 10 = 0.01 계약
   - Volume 1000 = 1 계약
   - Volume 값을 1000으로 나누면 실제 계약 수

2. **외환 (EURUSD)**
   - Volume 100,000 = 1 lot
   - Volume 10,000 = 0.1 lot
   - Volume 값을 100,000으로 나누면 실제 lot 수

### 중요한 차이점
- 나스닥 선물: 계약 단위로 표시
- 외환: 통화 단위로 표시
- 각 상품별로 Volume 표시 방식이 다름을 확인

### Volume = 0인 틱 분석

1. **#USNDAQ100**
   - Volume = 0인 틱: 1개 (0.00%)
   - 발생 시간: 2024.10.22 01:00:00 (시장 시작 시간)
   - 특징:
     - Last = 0 (거래 체결 없음)
     - Flags = 1030 (BID ASK 변경)
     - 단순 호가 변경만 있는 틱

2. **EURUSD**
   - Volume = 0인 틱: 2개 (0.00%)
   - 발생 시간: 
     - 2024.10.21 00:00:00
     - 2024.11.04 00:00:00
   - 특징:
     - Last = 0 (거래 체결 없음)
     - Flags = 6 (BID ASK 변경)
     - 시장 시작/종료 시점의 호가 갱신

### 중요한 발견
1. Volume = 0인 틱의 특징:
   - 시장 시작/종료 시점에 주로 발생
   - 거래 체결 없이 호가만 변경되는 경우
   - Last 가격이 0으로 표시됨
   - 전체 틱 대비 비중이 극히 적음 (0.00%)
   - 실제 거래와는 무관한 시장 상태 업데이트용 틱으로 판단됨

### Volume = 0인 틱 분석 (1억개 틱 데이터)

1. **#USNDAQ100**
   - 전체 틱 수: 81,333,217개
   - Volume = 0인 틱: 265,208개
   - 비율: 0.33%
   - 특징:
     - Flags = 6 (BID ASK 변경)
     - Last = 0
     - 연속적인 호가 변경이 발생
     - 주로 시장 시작/종료 시점에 집중

2. **EURUSD**
   - 전체 틱 수: 89,408,674개
   - Volume = 0인 틱: 58,182개
   - 비율: 0.07%
   - 특징:
     - Flags = 134 (BID ASK 변경)
     - Last = 0
     - 매우 짧은 시간 간격으로 호가 변경
     - 나스닥 대비 더 낮은 비율

### 중요한 발견
1. Volume = 0인 틱의 특징:
   - 두 상품 모두 0.5% 미만의 매우 낮은 비율
   - 모두 Last = 0으로 표시됨
   - 순수하게 호가(BID/ASK) 변경만 있는 틱
   - 실제 거래와는 무관한 시장 가격 갱신용 틱

2. 상품별 차이:
   - 나스닥: 0.33%로 상대적으로 높은 율
   - 유로달러: 0.07%로 매우 낮은 비율
   - 각 상품의 시장 특성이 반영된 것으로 판단됨

### iVolume과 iRealVolume의 차이

1. **iVolume (틱 카운트)**
   - 해당 기간 동안 발생한 틱의 총 개수
   - 가격이 변동된 횟수를 의미
   - 실제 거래량과 관계없이 가격 변화가 있을 때마다 +1
   - 시장 활성도를 측정하는데 유용

2. **iRealVolume (실제 거래량)**
   - 해당 기간 동안 발생한 모든 MqlTick.volume의 합
   - 실제 거래된 계약/로트의 총합
   - 나스닥 선물의 경우: Volume 값을 1000으로 나눈 값의 합이 실제 계약 수
   - 실제 거래 규모를 측정하는데 유용

### 예시

1분 동안 발생한 틱:
틱1: volume = 10 (0.01 계약)
틱2: volume = 20 (0.02 계약)
틱3: volume = 30 (0.03 계약)
iVolume = 3 (틱이 3번 발생)
iRealVolume = 60 (10 + 20 + 30 = 60, 즉 0.06 계약)

### 일봉 거래량 분석 (틱 카운트와 실제 거래량의 변화)

1. **틱 카운트(iVolume) 변화**
   - 46044 → 46045 → 46046 → 46047 → 46048 → 46049 → 46050 → 46051
   - 매 틱마다 1씩 증가
   - 가격 변동이 있을 때마다 카운트가 증가
   - 순수하게 가격 변동 횟수를 의미

2. **실제 거래량(iRealVolume) 변화**
   - 497450 → 497460 → 497470 → 497480 → 497490 → 497500 → 497510 → 497520
   - 매 틱마다 10씩 증가
   - 각 틱의 Volume이 10(0.01계약)임을 의미
   - 실제 거래된 계약의 누적량을 표시

3. **관계 분석**
   - 틱 카운트: 1씩 증가 (가격 변동 횟수)
   - 실제 거래량: 10씩 증가 (최소 거래 단위)
   - 모든 틱에서 0.01계약씩 거래가 발생하고 있음을 확인
   - 매우 일정한 패턴의 거래가 발생 중

### 틱 데이터의 중요한 특성 발견

1. **틱의 구분**
   - 같은 시간(밀리초까지 동일)에 발생한 틱이라도
   - 거래 체결(LAST VOLUME)과 호가 갱신(BID ASK)은 별개의 틱으로 처리됨
   - 즉, 하나의 거래가 두 개의 틱으로 기록됨

2. **거래량 증가 조건**
   - 거래 체결(LAST VOLUME) 틱에서만:
     - 틱 카운트(iVolume) 증가
     - 실제 거래량(iRealVolume) 증가
   - 호가 갱신(BID ASK) 틱에서는:
     - 틱 카운트와 실제 거래량 모두 변화 없음

3. **중요성**
   - 거래 시스템 개발 시 틱 처리 로직에 큰 영향
   - 실제 거래와 호가 갱신을 구분하여 처리 필요
   - 정확한 거래량 계산을 위해서는 LAST VOLUME 플래그 확인 필요

### 시작 시점 에러의 원인 발견

1. **에러의 근본 원인**
   - 하나의 거래가 두 개의 틱으로 기록되는 특성 때문
   - 거래 체결(LAST VOLUME)과 호가 갱신(BID ASK)이 별도의 틱으로 처리됨
   - 이로 인해 시작 시점에서 틱 카운트와 실제 거래량이 불일치하는 문제 발생

2. **문제 상황**
   - 같은 시간(밀리초까지 동일)에 발생한 틱이
   - 두 개의 독립된 틱으로 처리됨
   - 거래량은 LAST VOLUME 틱에서만 증가
   - BID ASK 틱에서는 거래량 변화 없음

3. **해결 방안**
   - 틱 처리 시 플래그를 먼저 확인
   - LAST VOLUME 플래그가 있는 틱만 거래량 계산에 포함
   - BID ASK 플래그만 있는 틱은 호가 갱신 용도로만 사용
   - 시작 시점의 틱 처리 로직 수정 필요

4. **향후 개발 시 고려사항**
   - 틱 데이터 처리 시 플래그 확인 필수
   - 거래량 계산 시 LAST VOLUME 틱만 사용
   - 호가 갱신은 BID ASK 틱 사용
   - 시작 시점의 특수한 처리 로직 필요

### 틱 카운트 누락 현상 발견

1. **현재 상황**
   - 틱 카운트: 70511 (14102-1) → 70514 (14102-4)
   - 중간의 70512 (14102-2)와 70513 (14102-3)이 누락됨
   - 실제 거래량은 연속적으로 증가

2. **원인 분석**
   - LAST VOLUME 틱만 필터링하여 출력하기 때문
   - 중간의 두 틱은 BID ASK 틱으로 추정
   - 실제로는 모든 틱이 발생했지만, LAST VOLUME 틱만 보여서 누락된 것처럼 보임

3. **중요한 의미**
   - 하나의 거래가 두 개의 틱으로 기록되는 현상 재확인
   - 거래 체결(LAST VOLUME)과 호가 갱신(BID ASK)이 번갈아 발생
   - 틱 카운트는 모든 틱을 포함하지만, 실제 거래는 LAST VOLUME 틱에서만 발생

4. **향후 고려사항**
   - 틱 분석 시 LAST VOLUME과 BID ASK 틱의 순서 패턴 파악 필요
   - 거래량 분석은 LAST VOLUME 틱만 사용
   - 호가 변동 분석은 BID ASK 틱 활용